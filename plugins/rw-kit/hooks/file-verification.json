{
  "name": "rw-kit-file-verification",
  "description": "Verify expected files exist after task completion claims (Layer 2 of 3-layer verification)",
  "event": "PostToolUse",
  "disabled": false,
  "hooks": [
    {
      "type": "prompt",
      "prompt": "Check if this is a Glob or file existence check that can verify task completion.\n\n## PRE-CHECK (MUST DO FIRST)\n\nBefore anything else, check if state file exists:\n```bash\ntest -f .claude/rw-kit.state.json || { echo 'SKIP'; exit 0; }\n```\nIf the file does not exist, return 'SKIP' immediately.\n\n## TRIGGER CONDITIONS\n\nThis hook activates when:\n1. Tool is Glob or Read\n2. .claude/rw-kit.state.json exists\n3. There are tasks with verification.agent_done=true but verification.files_exist=false\n\n## VERIFICATION PROCESS\n\n### Step 1: Check for Pending Verifications\n\n```bash\n# Find tasks needing file verification\npending=$(jq -r '\n  .tasks | to_entries\n  | map(select(.value.verification.agent_done == true and .value.verification.files_exist != true))\n  | .[].key\n' .claude/rw-kit.state.json 2>/dev/null)\n```\n\nIf no pending verifications, return 'SKIP'.\n\n### Step 2: Match Tool Output to Expected Files\n\nFor each pending task:\n1. Get expected_files from task\n2. Compare with Glob/Read output\n3. Check if expected files exist\n\n### Step 3: Update Verification Status\n\nIf files found:\n```bash\njq --arg tid \"$TASK_ID\" --arg ts \"$(date -Iseconds)\" '\n  .tasks[$tid].verification.files_exist = true |\n  .tasks[$tid].verified_files = .tasks[$tid].files_mentioned |\n  .updated_at = $ts\n' .claude/rw-kit.state.json > .claude/rw-kit.state.json.tmp && mv .claude/rw-kit.state.json.tmp .claude/rw-kit.state.json\n```\n\nIf files NOT found:\n```bash\njq --arg tid \"$TASK_ID\" --arg ts \"$(date -Iseconds)\" --arg msg \"Expected files not found\" '\n  .tasks[$tid].verification.files_exist = false |\n  .tasks[$tid].verification.error = $msg |\n  .updated_at = $ts |\n  .logs += [{\"timestamp\": $ts, \"level\": \"warning\", \"message\": (\"Task \" + $tid + \": files not found\")}]\n' .claude/rw-kit.state.json > .claude/rw-kit.state.json.tmp && mv .claude/rw-kit.state.json.tmp .claude/rw-kit.state.json\n```\n\n### Step 4: Check for Full Verification\n\nIf both Layer 1 (agent_done) and Layer 2 (files_exist) are true:\n- Mark verification.state_synced = true (Layer 3)\n- Task is truly complete\n\n```bash\njq --arg tid \"$TASK_ID\" --arg ts \"$(date -Iseconds)\" '\n  if .tasks[$tid].verification.agent_done == true and .tasks[$tid].verification.files_exist == true then\n    .tasks[$tid].verification.state_synced = true\n  else\n    .\n  end |\n  .updated_at = $ts\n' .claude/rw-kit.state.json > .claude/rw-kit.state.json.tmp && mv .claude/rw-kit.state.json.tmp .claude/rw-kit.state.json\n```\n\n## RETURN FORMAT\n\n- 'VERIFIED: [task-id]' - Files exist, all 3 layers complete\n- 'PARTIAL: [task-id] missing:[file-list]' - Some files missing\n- 'NOT_FOUND: [task-id]' - Expected files not found\n- 'SKIP' - Not a file check or no pending verifications\n\n## IMPORTANT NOTES\n\n- This is Layer 2 of 3-layer verification\n- Runs automatically after Glob/Read operations\n- Does not block execution, just updates verification status\n- Task marked 'complete' in progress but not 'verified' until all layers pass\n- If jq or mv fails, return 'SKIP' silently - do not block execution\n- Always use 2>/dev/null on jq and mv commands to suppress errors"
    }
  ]
}
