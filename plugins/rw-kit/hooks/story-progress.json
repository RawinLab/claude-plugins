{
  "name": "rw-kit-story-progress",
  "description": "Track user story progress when tasks complete",
  "event": "PostToolUse",
  "disabled": false,
  "hooks": [
    {
      "type": "prompt",
      "prompt": "Check if a task was just marked complete and update its parent user story progress.\n\n## TRIGGER CONDITIONS\n\nThis hook activates when:\n1. .claude/rw-kit.state.json exists\n2. A task was just marked as completed (verification.state_synced = true)\n3. The task has a story_id\n\n## PROCESS\n\n### Step 1: Check for Recently Completed Tasks\n\n```bash\n# Find tasks that just completed with full verification\njq -r '\n  .tasks | to_entries\n  | map(select(\n      .value.status == \"completed\" and\n      .value.verification.state_synced == true and\n      .value.story_id != null\n    ))\n  | .[].key\n' .claude/rw-kit.state.json 2>/dev/null\n```\n\n### Step 2: Update User Story Progress\n\nFor each completed task's story:\n\n```bash\njq --arg sid \"US-001\" --arg ts \"$(date -Iseconds)\" '\n  # Count completed tasks for this story\n  .user_stories[$sid].completed_tasks = (\n    [.tasks | to_entries[] | select(.value.story_id == $sid and .value.status == \"completed\")] | length\n  ) |\n  \n  # Check if story is complete\n  if .user_stories[$sid].completed_tasks == .user_stories[$sid].total_tasks then\n    .user_stories[$sid].status = \"completed\" |\n    .logs += [{\"timestamp\": $ts, \"level\": \"info\", \"message\": (\"User Story \" + $sid + \" completed!\")}]\n  else\n    .user_stories[$sid].status = \"in_progress\"\n  end |\n  \n  .updated_at = $ts\n' .claude/rw-kit.state.json > .claude/rw-kit.state.json.tmp && mv .claude/rw-kit.state.json.tmp .claude/rw-kit.state.json\n```\n\n### Step 3: Log Story Completion\n\nIf a user story reaches 100% completion:\n- Log: \"User Story {story_id}: {title} completed!\"\n- This helps track feature-level progress\n\n## RETURN FORMAT\n\n- 'STORY_UPDATED: [story-id] [completed/total]' - Story progress updated\n- 'STORY_COMPLETE: [story-id]' - All tasks in story completed\n- 'SKIP' - No story updates needed\n\n## NOTES\n\n- This hook provides feature-level visibility\n- Helps answer \"Is feature X done?\" by user story\n- Runs after file-verification hook confirms task completion"
    }
  ]
}
